<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <title>buoyDetector_test3/Look for Buoys/Analyze LabelMatrix for Buoys</title></head><link rel="StyleSheet" href="slwebview.css" type="text/css"><script type="text/javascript" src="id_mapping.js"></script><script type="text/javascript" src="slwebview.js"></script><script type="text/javascript" src="slwebview_utils.js"></script><script type="text/javascript" src="slhtmltoolbar.js"></script><body onload="addToolbar('toolbarDiv');"><table><tr><td><div id="toolbarDiv" style="display:inline"></div></td><td class="content" style="vertical-align:middle">Analyze LabelMatrix for Buoys</td></tr></table><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"><span style="color:blue">function</span> [successive_valid_image_count_out, buoy_id, buoy_count, buoy_hues, buoy_centroids] = Buoy_Extraction(successive_valid_image_count_in, blob_count, blob_hues, blob_centroids, blob_eccentricity, blob_extent, Min_Eccent, Max_Eccent, Min_Extent, Max_Extent, Buoy_Count_Min, Buoy_Count_Max)
<span style="color:green">% This function takes in vectors representing blobs present in the image,</span>
<span style="color:green">%   and returns information about how many and what kind of buoys are</span>
<span style="color:green">%   present.</span>
<span style="color:green">%</span>
<span style="color:green">% Input</span>
<span style="color:green">%   blob_count = integer number of blobs in image</span>
<span style="color:green">%   blob_hues = Nx1 vector of hues of blobs in image</span>
<span style="color:green">%   blob_centroids = Nx2 matrix of x-y pairs of blob centroid locations</span>
<span style="color:green">%   blob_eccentricity = Nx1 vector of blob eccentricites</span>
<span style="color:green">%   blob_extent = Nx1 vector of blob extents</span>
<span style="color:green">%</span>
<span style="color:green">%   Buoy_Count_Min = integer; minimum number of buoys searched for in an</span>
<span style="color:green">%     image (mission/controls needs requires this option)</span>
<span style="color:green">%   Buoy_Count_Max = maximum number of buoys allowed per image; arbitrary</span>
<span style="color:green">%     limit</span>
<span style="color:green">%   Min_Hue,Max_Hue = Nx1 limits on valid buoy hues; hue is between 0 and 1</span>
<span style="color:green">%   Min_Eccent,Max_Eccent = scalar limits on buoy eccentricity</span>
<span style="color:green">%   Min_Extent,Max_Extent = scalar limits on buoy extent</span>
<span style="color:green">%</span>
<span style="color:green">% Output</span>
<span style="color:green">%   successive_valid_image_count = integer value of the number of times an</span>
<span style="color:green">%     image with more than Min_Num_Buoys is processed; persistant between</span>
<span style="color:green">%     function calls, so that the number of successive images containing</span>
<span style="color:green">%     at least Min_Num_Buoys buoys is tracked</span>
<span style="color:green">%   buoy_count = integer number of buoys in image</span>
<span style="color:green">%   buoy_hues = Nx1 vector of buoy colors</span>
<span style="color:green">%   buoy_centroids = Nx2 matrix of x-y pairs of buoy centroid locations</span>


<span style="color:green">% Initialize</span>
<span style="color:green">%persistent successive_valid_image_count;</span>
buoy_count = double(0);

<span style="color:green">%debug</span>
<span style="color:green">%successive_valid_image_count = 0;</span>
Buoy_Count_Max = 50;


<span style="color:green">%/debug</span>
buoy_hues = double(zeros(Buoy_Count_Max,1));
buoy_centroids = double(-500.*ones(Buoy_Count_Max,2));  <span style="color:green">% Initialize to points clearly not located in image</span>

buoy_id = double(-1.*ones(Buoy_Count_Max,1));
Buoy_Hue_HalfRange = 10;
Buoy1_Hue = 30;
Buoy2_Hue = 80;
Buoy3_Hue = 15;

<span style="color:green">% Loop through blobs, and analyze and extract buoy information</span>
<span style="color:blue">for</span> i = 1:blob_count
    
    <span style="color:green">% Convert Lab to XYZ</span>
<span style="color:green">%    R = buoy_hues(i);</span>
<span style="color:green">%    G = buoy_hues(i);</span>
<span style="color:green">%    B = buoy_hues(i);</span>
    
    L = blob_hues(:,1); <span style="color:green">%refcolors(LabelMatrix(1,1,1));</span>
    a = blob_hues(:,2);
    b = blob_hues(:,3);
    
    var_Y = L./10;
    var_X = ( a./17.5 ).*( L./10 );
    var_Z = ( b./7 ).*( L./10 );
    
    Y = var_Y.^2;
    X = ( var_X + Y )./1.02;
    Z = -( var_Z - Y )./0.847;
    
    <span style="color:green">% Convert XYZ to RGB</span>
    var_X = X./100;        <span style="color:green">%X from 0 to  95.047      (Observer = 2 degrees, Illuminant = D65)</span>
    var_Y = Y./100;        <span style="color:green">%Y from 0 to 100.000</span>
    var_Z = Z./100;        <span style="color:green">%Z from 0 to 108.883</span>
    
    var_R = var_X.*3.2406 + var_Y.*(-1.5372) + var_Z.* -0.4986;
    var_G = var_X .* -0.9689 + var_Y .*  1.8758 + var_Z.*  0.0415;
    var_B = var_X .*  0.0557 + var_Y .* -0.2040 + var_Z .*  1.0570;
    
    var_R = ( var_R &gt; 0.0031308 ).*( 1.055.*( var_R.^( 1./2.4 ) ) - 0.055 ) + ( var_R &lt;= 0.0031308 ).*(12.92.*var_R);
    var_G = ( var_G &gt; 0.0031308 ).*( 1.055.*( var_G.^( 1./2.4 ) ) - 0.055 ) + ( var_G &lt;= 0.0031308 ).*( var_G &lt;= 12.92.*var_G );
    var_B = ( var_B &gt; 0.0031308 ).*( 1.055 .* ( var_B .^ ( 1 ./ 2.4 ) ) - 0.055 ) + ( var_B &lt;= 0.0031308 ).*( 12.92 .* var_B );
    
    R = var_R .* 255;
    G = var_G .* 255;
    B = var_B .* 255;
    
    <span style="color:green">% Convert RGB to HSV</span>
    var_R = ( R ./ 255 );  <span style="color:green">% RGB from 0 to 255</span>
    var_G = ( G ./ 255 );
    var_B = ( B ./ 255 );
    
    var_Min = min( [var_R, var_G, var_B], [], 2 );  <span style="color:green">% Min. value of RGB</span>
    var_Max = max( [var_R, var_G, var_B], [], 2 );  <span style="color:green">% Max. value of RGB</span>
    del_Max = var_Max - var_Min;  <span style="color:green">% Delta RGB value</span>
    
    V = var_Max;
    
<span style="color:green">%    H = (del_Max != 0).*(  );</span>
<span style="color:green">%    S = (del_Max != 0).*( del_Max./var_Max );</span>
    <span style="color:blue">if</span> ( max(abs(del_Max == 0)) );  <span style="color:green">% This is a gray, no chroma...</span>
        H = zeros(size(var_R));  <span style="color:green">% HSV results from 0 to 1</span>
        S = zeros(size(var_R));
    <span style="color:blue">else</span>  <span style="color:green">% Chromatic data...</span>
        
        S = del_Max ./ var_Max;
        
        del_R = ( ( ( var_Max - var_R ) ./ 6 ) + ( del_Max ./ 2 ) ) ./ del_Max;
        del_G = ( ( ( var_Max - var_G ) ./ 6 ) + ( del_Max ./ 2 ) ) ./ del_Max;
        del_B = ( ( ( var_Max - var_B ) ./ 6 ) + ( del_Max ./ 2 ) ) ./ del_Max;
        
        
        H = ( var_R == var_Max ).*( del_B - del_G ) + ( var_G == var_Max ).*( ( 1 ./ 3 ) + del_R - del_B ) + ( var_B == var_Max ).*( ( 2 ./ 3 ) + del_G - del_R );
        H = ( H &lt; 0 ).*( H + 1 ) + ( H &gt; 1 ).*( H - 1 );
        
        
<span style="color:green">%{        
</span><span style="color:green">        if( var_R == var_Max )
</span><span style="color:green">            H = del_B - del_G;
</span><span style="color:green">        elseif( var_G == var_Max )
</span><span style="color:green">            H = ( 1 ./ 3 ) + del_R - del_B;
</span><span style="color:green">        elseif( var_B == var_Max )
</span><span style="color:green">            H = ( 2 ./ 3 ) + del_G - del_R;
</span><span style="color:green">        else
</span><span style="color:green">            H = 0;
</span><span style="color:green">        end
</span><span style="color:green">        
</span><span style="color:green">        if( H &lt; 0 )
</span><span style="color:green">            H = H + 1;
</span><span style="color:green">        end
</span><span style="color:green">        if( H &gt; 1 )
</span><span style="color:green">            H = H - 1;
</span><span style="color:green">        end
</span><span style="color:green">%}        
</span>    <span style="color:blue">end</span>
    
    
    
    
    
    
    
    
    
    <span style="color:green">% Store buoy information if blob conditions are met</span>
    <span style="color:green">%   Conditions: 1) Blob eccentricity is within specified range</span>
    <span style="color:green">%               2) Blob extent is within specified range</span>
    <span style="color:green">%               3) Blob hue is within specified range for several buoy</span>
    <span style="color:green">%                 types</span>
    <span style="color:blue">if</span>( (blob_eccentricity(i)&gt;=Min_Eccent) &amp;&amp; (blob_eccentricity(i)&lt;=Max_Eccent) &amp;&amp; (blob_extent(i)&gt;=Min_Extent) &amp;&amp; (blob_extent(i)&lt;=Max_Extent) )
        
        <span style="color:green">%if( (blob_hues(i)&gt;=Buoy1_Hue-Buoy_Hue_HalfRange) &amp;&amp; (blob_hues(i)&lt;=Buoy1_Hue+Buoy_Hue_HalfRange) )</span>
            buoy_count = buoy_count + 1;
            buoy_hues(buoy_count) = blob_hues(i);
            buoy_id(buoy_count) = 1;
            buoy_centroids(buoy_count,1) = blob_centroids(i,1);
            buoy_centroids(buoy_count,2) = blob_centroids(i,2);
        <span style="color:green">%end</span>
        <span style="color:blue">if</span>( (blob_hues(i)&gt;=Buoy2_Hue-Buoy_Hue_HalfRange) &amp;&amp; (blob_hues(i)&lt;=Buoy2_Hue+Buoy_Hue_HalfRange) )
            buoy_count = buoy_count + 1;
            buoy_hues(buoy_count) = blob_hues(i);
            buoy_id(buoy_count) = 2;
            buoy_centroids(buoy_count,1) = blob_centroids(i,1);
            buoy_centroids(buoy_count,2) = blob_centroids(i,2);
        <span style="color:blue">end</span>
        <span style="color:blue">if</span>( (blob_hues(i)&gt;=Buoy3_Hue-Buoy_Hue_HalfRange) &amp;&amp; (blob_hues(i)&lt;=Buoy3_Hue+Buoy_Hue_HalfRange) )
            buoy_count = buoy_count + 1;
            buoy_hues(buoy_count) = blob_hues(i);
            buoy_id(buoy_count) = 3;
            buoy_centroids(buoy_count,1) = blob_centroids(i,1);
            buoy_centroids(buoy_count,2) = blob_centroids(i,2);
        <span style="color:blue">end</span>
    <span style="color:blue">end</span>
    
<span style="color:blue">end</span>

<span style="color:blue">if</span>( buoy_count &gt;= Buoy_Count_Min )
    successive_valid_image_count_out = double(successive_valid_image_count_in + 1);
<span style="color:blue">else</span>
    successive_valid_image_count_out = double(0);
<span style="color:blue">end</span>


<span style="color:green">% Resize output arrays</span>
<span style="color:green">%buoy_hues = buoy_hues(1:buoy_count);</span>
<span style="color:green">%buoy_centroids = buoy_centroids(1:buoy_count,:);</span>
<span style="color:green">%buoy_id = ;</span>

<span style="color:blue">return</span></pre></body></html>