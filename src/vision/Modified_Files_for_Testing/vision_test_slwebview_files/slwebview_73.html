<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <title>validation_gate_test/IterativeSegmentation/Segmentation/Reference Color Selection</title></head><link rel="StyleSheet" href="slwebview.css" type="text/css"><script type="text/javascript" src="id_mapping.js"></script><script type="text/javascript" src="slwebview.js"></script><script type="text/javascript" src="slwebview_utils.js"></script><script type="text/javascript" src="slhtmltoolbar.js"></script><body onload="addToolbar('toolbarDiv');"><table><tr><td><div id="toolbarDiv" style="display:inline"></div></td><td class="content" style="vertical-align:middle">Reference Color Selection</td></tr></table><pre xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd"><span style="color:blue">function</span> [ref_colors, num_colors] = Segmentation(L,a,b,Dist_Thresh)
<span style="color:green">% This function tries segmentation by adding new reference colors everytime</span>
<span style="color:green">% a pixel is found with a distance greater than a certain amount from</span>
<span style="color:green">% every other reference color</span>

[rows cols] = size(L);

Dist_Threshold = Dist_Thresh;<span style="color:green">% L = 0 to 100, a = -100 to 100, b = -100 to 100</span>
                    <span style="color:green">% max dist = 300 -&gt; 60/300 is 20%</span>
x = 1;  <span style="color:green">% coefficients determining distance calculation</span>
y = 1.5;
z = 1.5;

max_num_colors = 50;
ref_colors = zeros(max_num_colors,3);   <span style="color:green">% At most 50 different reference colors</span>
LabelMatrix = zeros(rows,cols);
num_colors = 1;

center_row = floor(rows/2);
center_col = floor(cols/2);

<span style="color:green">% Define first reference color to be colr</span>
ref_colors(1,:) = [L(center_row,center_col) a(center_row,center_col) b(center_row,center_col)];

flag = 0;
i = 1;
j = 1;
<span style="color:blue">while</span>(i &lt;= rows)        <span style="color:green">% perform initial segmentation</span>
    <span style="color:blue">while</span>(i &lt;= rows &amp;&amp; flag == 0)
        <span style="color:blue">while</span>(j &lt;= cols &amp;&amp; flag == 0)
            k = 1;
            min_dist = 1000;
            index = 1;
            <span style="color:blue">while</span>(k &lt;= num_colors)
                dist = sqrt(x*(ref_colors(k,1) - L(i,j))^2 + y*(ref_colors(k,2) - a(i,j))^2 + z*(ref_colors(k,3) - b(i,j))^2);
                <span style="color:blue">if</span>(min_dist &gt; dist)
                    min_dist = double(dist);
                    index = k;
                <span style="color:blue">end</span>
                k = k + 1;
            <span style="color:blue">end</span>
            <span style="color:blue">if</span>(j == 117)
                cow = 1;
            <span style="color:blue">end</span>
            <span style="color:blue">if</span>(min_dist &gt; Dist_Threshold &amp;&amp; num_colors &lt; max_num_colors)
                ref_colors(num_colors+1,:) = [L(i,j) a(i,j) b(i,j)];
                num_colors = num_colors + 1;
                flag = 1;
                i = 0;
                j = 0;
            <span style="color:blue">else</span>
                LabelMatrix(i,j) = index;
            <span style="color:blue">end</span>
            j = j + 1;
        <span style="color:blue">end</span>
        j = 1;
        i = i + 1;
    <span style="color:blue">end</span>
    flag = 0;
<span style="color:blue">end</span>

<span style="color:green">% Go through image once more to get more accurate values for the different regions</span>
ref_color_L_avg = zeros(50,1);
ref_color_a_avg = zeros(50,1);
ref_color_b_avg = zeros(50,1);
color_count = zeros(50,1);
<span style="color:blue">for</span> i = 1:rows
    <span style="color:blue">for</span> j = 1:cols
        index = LabelMatrix(i,j);
        ref_color_L_avg(index) = ref_color_L_avg(index) + L(i,j);
        ref_color_a_avg(index) = ref_color_a_avg(index) + a(i,j);
        ref_color_b_avg(index) = ref_color_b_avg(index) + b(i,j);
        color_count(index) = color_count(index) + 1;
    <span style="color:blue">end</span>
<span style="color:blue">end</span>
ref_color_L_avg = ref_color_L_avg ./ color_count;
ref_color_a_avg = ref_color_a_avg ./ color_count;
ref_color_b_avg = ref_color_b_avg ./ color_count;

<span style="color:blue">for</span> i = 1:num_colors
    ref_colors(i,1) = ref_color_L_avg(i);
    ref_colors(i,2) = ref_color_a_avg(i);
    ref_colors(i,3) = ref_color_b_avg(i);
<span style="color:blue">end</span>

<span style="color:blue">return</span>
</pre></body></html>